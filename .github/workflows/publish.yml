name: Publish to Sonatype Central

on:
  workflow_run:
    workflows: ["PR Check - Build & Test Coverage"]
    types:
      - completed
    branches:
      - staging
      - master
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    # Sadece pr-check başarılı olduysa çalış
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Determine version
        id: version
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          echo "Branch: $BRANCH"
          
          if [ "$BRANCH" == "staging" ]; then
            VERSION="1.0.0-beta.${{ github.run_number }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_snapshot=true" >> $GITHUB_OUTPUT
            echo "branch=staging" >> $GITHUB_OUTPUT
          else
            # Master/main branch - use version from gradle.properties or default
            VERSION=$(grep "MIMEDA_SDK_VERSION" gradle.properties | cut -d'=' -f2 | tr -d ' ')
            if [ -z "$VERSION" ]; then
              VERSION="1.0.0"
            fi
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_snapshot=false" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          fi
          echo "Determined version: $VERSION"
      
      - name: Update gradle.properties with version
        run: |
          if [ "${{ steps.version.outputs.is_snapshot }}" == "true" ]; then
            sed -i "s/MIMEDA_SDK_VERSION=.*/MIMEDA_SDK_VERSION=${{ steps.version.outputs.version }}/" gradle.properties
          fi
          echo "Updated MIMEDA_SDK_VERSION to ${{ steps.version.outputs.version }}"
      
      - name: Import GPG key
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          if [ -n "$SIGNING_KEY" ] && [ -n "$SIGNING_PASSWORD" ]; then
            echo "$SIGNING_KEY" | base64 --decode | gpg --batch --import
            gpg --list-secret-keys --keyid-format LONG
          else
            echo "GPG signing keys not found, skipping signing"
          fi
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build release AAR
        run: ./gradlew :app:assembleProductionRelease
      
      - name: Publish to Sonatype Central
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          ./gradlew :app:publishReleasePublicationToMavenRepository
      
      - name: Close and release staging repository (Master only)
        if: (github.event.workflow_run.head_branch == 'master' || github.event.workflow_run.head_branch == 'main') && steps.version.outputs.is_snapshot == 'false'
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        run: |
          # Sonatype Central için staging repository'yi otomatik olarak close ve release etmek için
          # nexus-staging-maven-plugin kullanılabilir, ancak bu Gradle projesi için
          # manuel olarak Sonatype Central web arayüzünden yapılması gerekebilir
          # veya REST API kullanılabilir
          echo "Staging repository should be closed and released manually from Sonatype Central web interface"
          echo "Or use Sonatype Central REST API to automate this step"
      
      - name: Create release tag (Master only)
        if: (github.event.workflow_run.head_branch == 'master' || github.event.workflow_run.head_branch == 'main') && steps.version.outputs.is_snapshot == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release version ${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

