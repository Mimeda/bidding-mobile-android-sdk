name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, master, staging ]
    types: [ opened, synchronize, reopened ]
  push:
    branches:
      - staging
      - master
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  # ============================================
  # Build & Test - PR ve Push'larda Ã§alÄ±ÅŸÄ±r
  # ============================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Build project
        run: ./gradlew assembleDebug --no-daemon
        
      - name: Run Unit Tests
        run: ./gradlew testStagingDebugUnitTest --no-daemon
        
      - name: Generate Test Coverage Report
        run: ./gradlew jacocoTestReport --no-daemon
        
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: app/build/reports/tests/
          retention-days: 7
          
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: app/build/reports/jacoco/
          retention-days: 7

      - name: Add Coverage PR Comment
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 60
          min-coverage-changed-files: 80
          title: "ðŸ“Š Test Coverage Report"
          update-comment: true
          pass-emoji: 'âœ…'
          fail-emoji: 'âŒ'

      - name: Test Summary
        uses: test-summary/action@v2
        if: always()
        with:
          paths: app/build/test-results/**/TEST-*.xml

  # ============================================
  # Lint Check - PR ve Push'larda Ã§alÄ±ÅŸÄ±r
  # ============================================
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Run Lint
        run: ./gradlew lintStagingDebug --no-daemon
        
      - name: Upload Lint Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: app/build/reports/lint-results-*.html
          retention-days: 7

  # ============================================
  # Deploy - Sadece push'larda (PR merge sonrasÄ±)
  # build-and-test ve lint baÅŸarÄ±lÄ± olursa Ã§alÄ±ÅŸÄ±r
  # ============================================
  deploy:
    name: Deploy to Sonatype Central
    runs-on: ubuntu-latest
    needs: [build-and-test, lint]
    # Sadece push event'inde Ã§alÄ±ÅŸ (PR'larda Ã§alÄ±ÅŸmaz)
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Determine version and environment
        id: version
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "Branch: $BRANCH"
          
          if [ "$BRANCH" == "staging" ]; then
            VERSION="1.0.0-beta.${{ github.run_number }}-SNAPSHOT"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_staging=true" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            # Master/main branch - production
            VERSION=$(grep "MIMEDA_SDK_VERSION" gradle.properties | cut -d'=' -f2 | tr -d ' ')
            if [ -z "$VERSION" ]; then
              VERSION="1.0.0"
            fi
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_staging=false" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
          fi
          echo "Determined version: $VERSION"
      
      - name: Update gradle.properties with version
        run: |
          sed -i "s/MIMEDA_SDK_VERSION=.*/MIMEDA_SDK_VERSION=${{ steps.version.outputs.version }}/" gradle.properties
          echo "Updated MIMEDA_SDK_VERSION to ${{ steps.version.outputs.version }}"
          cat gradle.properties | grep MIMEDA_SDK_VERSION
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build release artifacts
        run: |
          echo "ðŸ”¨ Building release AAR..."
          ./gradlew :app:assembleProductionRelease --no-daemon
          
          echo "ðŸ“¦ Generating POM, sources and javadoc..."
          ./gradlew :app:generatePomFileForMavenPublication --no-daemon || true
          ./gradlew :app:sourceJar --no-daemon || true
          ./gradlew :app:javaDocJar --no-daemon || true
      
      - name: Prepare artifacts for signing
        id: artifacts
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          GROUP_PATH="tr/com/mimeda"
          ARTIFACT_ID="bidding-mobile-android-sdk"
          
          # Create bundle directory structure
          BUNDLE_DIR="bundle/${GROUP_PATH}/${ARTIFACT_ID}/${VERSION}"
          mkdir -p "$BUNDLE_DIR"
          
          # Find and copy AAR
          AAR_FILE=$(find app/build/outputs/aar -name "*.aar" 2>/dev/null | head -1)
          if [ -z "$AAR_FILE" ]; then
            AAR_FILE=$(find app/build -name "*.aar" -type f 2>/dev/null | head -1)
          fi
          
          if [ -z "$AAR_FILE" ]; then
            echo "âŒ AAR file not found!"
            exit 1
          fi
          
          echo "âœ… Found AAR: $AAR_FILE"
          cp "$AAR_FILE" "$BUNDLE_DIR/${ARTIFACT_ID}-${VERSION}.aar"
          echo "âœ… AAR copied"
          
          # Create POM file with License and SCM (required by Central)
          cat > "$BUNDLE_DIR/${ARTIFACT_ID}-${VERSION}.pom" << 'POMEOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>tr.com.mimeda</groupId>
            <artifactId>bidding-mobile-android-sdk</artifactId>
            <version>VERSION_PLACEHOLDER</version>
            <packaging>aar</packaging>
            <name>Mimeda Android SDK</name>
            <description>Android SDK for Mimeda bidding platform</description>
            <url>https://mimeda.com.tr</url>
            
            <licenses>
              <license>
                <name>Proprietary</name>
                <url>https://mimeda.com.tr/sdk/license</url>
                <distribution>repo</distribution>
              </license>
            </licenses>
            
            <scm>
              <url>https://mimeda.com.tr</url>
              <connection>scm:git:https://mimeda.com.tr</connection>
              <developerConnection>scm:git:https://mimeda.com.tr</developerConnection>
            </scm>
            
            <developers>
              <developer>
                <name>Mimeda Team</name>
                <organization>Mimeda</organization>
                <organizationUrl>https://mimeda.com.tr</organizationUrl>
              </developer>
            </developers>
            
            <dependencies>
              <dependency>
                <groupId>com.squareup.okhttp3</groupId>
                <artifactId>okhttp</artifactId>
                <version>4.12.0</version>
                <scope>compile</scope>
              </dependency>
              <dependency>
                <groupId>com.squareup.okhttp3</groupId>
                <artifactId>logging-interceptor</artifactId>
                <version>4.12.0</version>
                <scope>compile</scope>
              </dependency>
              <dependency>
                <groupId>com.google.code.gson</groupId>
                <artifactId>gson</artifactId>
                <version>2.10.1</version>
                <scope>compile</scope>
              </dependency>
              <dependency>
                <groupId>androidx.core</groupId>
                <artifactId>core-ktx</artifactId>
                <version>1.17.0</version>
                <scope>runtime</scope>
              </dependency>
              <dependency>
                <groupId>androidx.security</groupId>
                <artifactId>security-crypto</artifactId>
                <version>1.1.0-alpha06</version>
                <scope>runtime</scope>
              </dependency>
            </dependencies>
          </project>
          POMEOF
          
          # Replace version placeholder
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" "$BUNDLE_DIR/${ARTIFACT_ID}-${VERSION}.pom"
          echo "âœ… POM created"
          
          # Create empty sources and javadoc jars (required by Central)
          cd "$BUNDLE_DIR"
          echo "Manifest-Version: 1.0" > manifest.txt
          jar cfm "${ARTIFACT_ID}-${VERSION}-sources.jar" manifest.txt
          jar cfm "${ARTIFACT_ID}-${VERSION}-javadoc.jar" manifest.txt
          rm manifest.txt
          cd -
          echo "âœ… Sources and Javadoc JARs created"
          
          echo "bundle_dir=$BUNDLE_DIR" >> $GITHUB_OUTPUT
          echo "artifact_id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
      
      - name: Import GPG key and sign artifacts
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          BUNDLE_DIR="${{ steps.artifacts.outputs.bundle_dir }}"
          ARTIFACT_ID="${{ steps.artifacts.outputs.artifact_id }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "ðŸ” Importing GPG key..."
          
          # Import the key (try base64 decode first, then raw)
          if echo "$SIGNING_KEY" | base64 -d 2>/dev/null | gpg --batch --import 2>/dev/null; then
            echo "âœ… GPG key imported (was base64 encoded)"
          elif echo "$SIGNING_KEY" | gpg --batch --import 2>/dev/null; then
            echo "âœ… GPG key imported (was raw ASCII)"
          else
            echo "âŒ Failed to import GPG key"
            exit 1
          fi
          
          # Sign all artifacts
          echo "âœï¸ Signing artifacts..."
          cd "$BUNDLE_DIR"
          
          for file in *.aar *.pom *.jar; do
            if [ -f "$file" ]; then
              echo "Signing $file..."
              echo "$SIGNING_PASSWORD" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 -ab "$file"
              if [ -f "${file}.asc" ]; then
                echo "âœ… ${file}.asc created"
              else
                echo "âŒ Failed to sign $file"
                exit 1
              fi
            fi
          done
      
      - name: Generate checksums
        run: |
          BUNDLE_DIR="${{ steps.artifacts.outputs.bundle_dir }}"
          cd "$BUNDLE_DIR"
          
          echo "ðŸ”¢ Generating checksums..."
          
          # Generate MD5 and SHA1 for all artifacts (not for .asc files)
          for file in *.aar *.pom *.jar; do
            if [ -f "$file" ]; then
              echo "Generating checksums for $file..."
              md5sum "$file" | cut -d' ' -f1 > "${file}.md5"
              sha1sum "$file" | cut -d' ' -f1 > "${file}.sha1"
              echo "âœ… ${file}.md5 and ${file}.sha1 created"
            fi
          done
      
      - name: Create deployment bundle
        id: bundle
        run: |
          cd bundle
          zip -r ../central-bundle.zip .
          cd ..
          echo "bundle_path=central-bundle.zip" >> $GITHUB_OUTPUT
      
      - name: Upload to Sonatype Central
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ENVIRONMENT="${{ steps.version.outputs.environment }}"
          
          echo "ðŸš€ Uploading version $VERSION to Sonatype Central..."
          
          # Create auth token (base64 of username:password)
          AUTH_TOKEN=$(echo -n "${OSSRH_USERNAME}:${OSSRH_PASSWORD}" | base64)
          
          # Upload bundle
          # publishingType: USER_MANAGED requires manual approval on Sonatype Central Portal
          PUBLISHING_TYPE="USER_MANAGED"
          
          RESPONSE=$(curl --request POST \
            --silent \
            --write-out "\n%{http_code}" \
            --header "Authorization: Bearer ${AUTH_TOKEN}" \
            --form "bundle=@central-bundle.zip" \
            "https://central.sonatype.com/api/v1/publisher/upload?name=mimeda-sdk-${VERSION}&publishingType=${PUBLISHING_TYPE}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" -eq 201 ]; then
            DEPLOYMENT_ID="$BODY"
            echo "âœ… Upload successful! Deployment ID: $DEPLOYMENT_ID"
            echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_ENV
          else
            echo "âŒ Upload failed with HTTP $HTTP_CODE"
            exit 1
          fi
      
      - name: Create release tag (Production only)
        if: steps.version.outputs.is_staging == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release version ${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"
          echo "âœ… Created tag v${{ steps.version.outputs.version }}"
      
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.version.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
