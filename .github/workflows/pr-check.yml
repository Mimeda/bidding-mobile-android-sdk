name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, master, staging ]
    types: [ opened, synchronize, reopened ]
  push:
    branches:
      - staging
      - master
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  # ============================================
  # Build & Test - PR ve Push'larda Ã§alÄ±ÅŸÄ±r
  # ============================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Build project
        run: ./gradlew assembleDebug --no-daemon
        
      - name: Run Unit Tests
        run: ./gradlew testStagingDebugUnitTest --no-daemon
        
      - name: Generate Test Coverage Report
        run: ./gradlew jacocoTestReport --no-daemon
        
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: app/build/reports/tests/
          retention-days: 7
          
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: app/build/reports/jacoco/
          retention-days: 7

      - name: Add Coverage PR Comment
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 60
          min-coverage-changed-files: 80
          title: "ðŸ“Š Test Coverage Report"
          update-comment: true
          pass-emoji: 'âœ…'
          fail-emoji: 'âŒ'

      - name: Test Summary
        uses: test-summary/action@v2
        if: always()
        with:
          paths: app/build/test-results/**/TEST-*.xml

  # ============================================
  # Lint Check - PR ve Push'larda Ã§alÄ±ÅŸÄ±r
  # ============================================
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Run Lint
        run: ./gradlew lintStagingDebug --no-daemon
        
      - name: Upload Lint Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: app/build/reports/lint-results-*.html
          retention-days: 7

  # ============================================
  # Deploy - Sadece push'larda (PR merge sonrasÄ±)
  # build-and-test ve lint baÅŸarÄ±lÄ± olursa Ã§alÄ±ÅŸÄ±r
  # ============================================
  deploy:
    name: Deploy to Sonatype Central
    runs-on: ubuntu-latest
    needs: [build-and-test, lint]
    # Sadece push event'inde Ã§alÄ±ÅŸ (PR'larda Ã§alÄ±ÅŸmaz)
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Determine version and environment
        id: version
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "Branch: $BRANCH"
          
          if [ "$BRANCH" == "staging" ]; then
            VERSION="1.0.0-beta.${{ github.run_number }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_staging=true" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            # Master/main branch - production
            VERSION=$(grep "MIMEDA_SDK_VERSION" gradle.properties | cut -d'=' -f2 | tr -d ' ')
            if [ -z "$VERSION" ]; then
              VERSION="1.0.0"
            fi
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_staging=false" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
          fi
          echo "Determined version: $VERSION"
      
      - name: Update gradle.properties with version
        run: |
          sed -i "s/MIMEDA_SDK_VERSION=.*/MIMEDA_SDK_VERSION=${{ steps.version.outputs.version }}/" gradle.properties
          echo "Updated MIMEDA_SDK_VERSION to ${{ steps.version.outputs.version }}"
          cat gradle.properties | grep MIMEDA_SDK_VERSION
      
      - name: Import GPG key
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
        run: |
          if [ -n "$SIGNING_KEY" ] && [ -n "$SIGNING_PASSWORD" ]; then
            # GPG dizinini oluÅŸtur
            mkdir -p ~/.gnupg
            chmod 700 ~/.gnupg
            
            # GPG agent ayarlarÄ± - loopback pinentry iÃ§in
            echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
            echo "allow-preset-passphrase" >> ~/.gnupg/gpg-agent.conf
            
            echo "use-agent" > ~/.gnupg/gpg.conf
            echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
            
            chmod 600 ~/.gnupg/*
            
            # GPG agent'Ä± yeniden baÅŸlat
            gpgconf --kill gpg-agent || true
            gpg-agent --daemon || true
            
            # Key'i import et
            echo "$SIGNING_KEY" | base64 -d | gpg --batch --import
            
            # Passphrase'i preset et (signing sÄ±rasÄ±nda sorulmasÄ±n)
            KEYGRIP=$(gpg --list-secret-keys --with-keygrip --with-colons 2>/dev/null | grep grp | head -1 | cut -d: -f10)
            if [ -n "$KEYGRIP" ]; then
              echo "$SIGNING_PASSWORD" | /usr/lib/gnupg/gpg-preset-passphrase --preset "$KEYGRIP" 2>/dev/null || true
            fi
            
            # Import edildi mi kontrol et
            echo "âœ… GPG keys imported"
            gpg --list-secret-keys --keyid-format LONG
          else
            echo "âš ï¸ GPG signing keys not found, skipping signing"
          fi
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build release AAR
        run: ./gradlew :app:assembleProductionRelease --no-daemon
      
      - name: Setup credentials
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        run: |
          # Sonatype credentials'larÄ± gradle.properties'e ekle
          {
            echo ""
            echo "OSSRH_USERNAME=$OSSRH_USERNAME"
            echo "OSSRH_PASSWORD=$OSSRH_PASSWORD"
          } >> gradle.properties
          
          echo "âœ… Credentials configured"
      
      - name: Publish to Sonatype Central
        env:
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          echo "ðŸš€ Publishing version ${{ steps.version.outputs.version }} to ${{ steps.version.outputs.environment }}"
          
          # GPG passphrase iÃ§in environment
          export GPG_TTY=$(tty) || true
          
          # Gradle'a signing.gnupg.passphrase geÃ§
          ./gradlew :app:publishReleasePublicationToMavenRepository \
            -Psigning.gnupg.passphrase="$SIGNING_PASSWORD" \
            --no-daemon
      
      - name: Create release tag (Production only)
        if: steps.version.outputs.is_staging == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release version ${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"
          echo "âœ… Created tag v${{ steps.version.outputs.version }}"
      
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.version.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
